<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Say hello to x86_64 Assembly [part 4], 孙老师">
    <meta name="description" content="翻译原文地址
Say hello to x86_64 Assembly [part 4]不久前，我开始写一系列关于x86_64汇编编程的博客文章。你可以通过asm标签找到它。不幸的是，我上次很忙，没有新的帖子，所以今天我继续写关于大会的帖子">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Say hello to x86_64 Assembly [part 4] | 孙老师</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    
    <script src="/libs/jquery/jquery.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">孙老师</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">孙老师</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/zhanweisun" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/zhanweisun" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/10.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Say hello to x86_64 Assembly [part 4]
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/x86/">
                                <span class="chip bg-color">x86</span>
                            </a>
                        
                            <a href="/tags/x64/">
                                <span class="chip bg-color">x64</span>
                            </a>
                        
                            <a href="/tags/%E6%B1%87%E7%BC%96/">
                                <span class="chip bg-color">汇编</span>
                            </a>
                        
                            <a href="/tags/assembly/">
                                <span class="chip bg-color">assembly</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-01-11
                </div>
                

                

                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    13 分
                </div>
                
				
                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
            
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><a href="https://github.com/0xAX/asm" target="_blank" rel="noopener">翻译原文地址</a></p>
<h3 id="Say-hello-to-x86-64-Assembly-part-4"><a href="#Say-hello-to-x86-64-Assembly-part-4" class="headerlink" title="Say hello to x86_64 Assembly [part 4]"></a>Say hello to x86_64 Assembly [part 4]</h3><p>不久前，我开始写一系列关于x86_64汇编编程的博客文章。你可以通过asm标签找到它。不幸的是，我上次很忙，没有新的帖子，所以今天我继续写关于大会的帖子，并将努力做到每周。</p>
<p>Some time ago i started to write series of blog posts about assembly programming for x86_64. You can find it by asm tag. Unfortunately i was busy last time and there were not new post, so today I continue to write posts about assembly, and will try to do it every week.</p>
<p>今天我们要看字符串和一些字符串操作。我们仍然使用NASM汇编和Linux X86_64。</p>
<p>Today we will look at strings and some strings operations. We still use nasm assembler, and linux x86_64.</p>
<h4 id="反转字符串"><a href="#反转字符串" class="headerlink" title="反转字符串"></a>反转字符串</h4><p>Reverse string</p>
<p>当然，当我们谈论汇编语言时，我们不能谈论字符串数据类型，实际上我们是在处理字节数组。让我们尝试编写一个简单的示例，我们将定义字符串数据，并尝试将结果反向并通过stdout输出。当我们开始学习新的编程语言时，这些任务看起来非常简单和流行。让我们看看实现。<br>首先，我定义初始化数据。它将放在数据部分（您可以阅读有关部分的内容）：</p>
<p>Of course when we talk about assembly programming language we can’t talk about string data type, actually we’re dealing with array of bytes. Let’s try to write simple example, we will define string data and try to reverse and write result to stdout. This tasks seems pretty simple and popular when we start to learn new programming language. Let’s look on implementation.</p>
<p>First of all, I define initialized data. It will be placed in data section (You can read about sections in part):</p>
<pre class=" language-nasm"><code class="language-nasm"><span class="token keyword">section .data</span>
        SYS_WRITE equ <span class="token number">1</span>
        STD_OUT   equ <span class="token number">1</span>
        SYS_EXIT  equ <span class="token number">60</span>
        EXIT_CODE equ <span class="token number">0</span>

        NEW_LINE db <span class="token number">0xa</span>
        INPUT db <span class="token string">"Hello world!"</span></code></pre>
<p>这里我们可以看到四个常数：</p>
<ul>
<li>SYS_WRITE-“写入”系统调用号</li>
<li>STD_OUT-stdout文件描述符</li>
<li>SYS_EXIT-“退出”系统的Syscall号</li>
<li>EXIT_CODE-退出代码</li>
</ul>
<p>你可以在这里找到系统调用列表。也有定义：</p>
<ul>
<li>NEW_LINE-新行（\n）符号</li>
<li>INPUT-我们的输入字符串，我们将反转它</li>
</ul>
<p>接下来，我们为缓冲区定义bss部分，在这里我们将放置反向字符串：</p>
<p>Here we can see four constants:</p>
<ul>
<li><code>SYS_WRITE</code> - ‘write’ syscall number</li>
<li><code>STD_OUT</code> - stdout file descriptor</li>
<li><code>SYS_EXIT</code> - ‘exit’ syscall number</li>
<li><code>EXIT_CODE</code> - exit code</li>
</ul>
<p>syscall list you can find - here. Also there defined:</p>
<ul>
<li><code>NEW_LINE</code> - new line (\n) symbol</li>
<li><code>INPUT</code> - our input string, which we will reverse</li>
</ul>
<p>Next we define bss section for our buffer, where we will put reversed string:</p>
<pre class=" language-nasm"><code class="language-nasm"><span class="token keyword">section .bss</span>
        OUTPUT resb <span class="token number">12</span></code></pre>
<p>好的，我们有一些数据和缓冲区用来存放结果，现在我们可以定义代码的文本段。让我们从主启动程序开始：</p>
<p>Ok we have some data and buffer where to put result, now we can define text section for code. Let’s start from main _start routine:</p>
<pre class=" language-nasm"><code class="language-nasm"><span class="token label function">_start:</span>
        mov <span class="token register variable">rsi</span>, INPUT
        xor <span class="token register variable">rcx</span>, <span class="token register variable">rcx</span>
        cld
        mov <span class="token register variable">rdi</span>, <span class="token operator">$</span> <span class="token operator">+</span> <span class="token number">15</span>
        call calculateStrLength
        xor <span class="token register variable">rax</span>, <span class="token register variable">rax</span>
        xor <span class="token register variable">rdi</span>, <span class="token register variable">rdi</span>
        jmp reverseStr</code></pre>
<p>这里有一些新东西。让我们看看它是如何工作的：首先，我们把INPUT的地址放在第2行的rsi寄存器中，就像我们写stdout和写零到rcx寄存器一样，它将是计算字符串长度的计数器。在第四行我们可以看到cld操作符。它将df flag重置为零。因为当我们计算字符串的长度时需要它，我们将遍历该字符串的内容元素，如果df flag为0，我们将从左到右处理字符串的符号。接下来我们调用calculateStrLength函数。我略过了有mov rdi指令的第5行，$+15指令，我稍后会告诉您。现在让我们看一下calculateStrength的实现：</p>
<p>Here are some new things. Let’s see how it works: First of all we put INPUT address to si register at line 2, as we did for writing to stdout and write zeros to rcx register, it will be counter for calculating length of our string. At line 4 we can see cld operator. It resets df flag to zero. We need in it because when we will calculate length of string, we will go through symbols of this string, and if df flag will be 0, we will handle symbols of string from left to right. Next we call calculateStrLength function. I missed line 5 with mov rdi, $ + 15 instruction, i will tell about it little later. And now let’s look at calculateStrLength implementation:</p>
<pre class=" language-nasm"><code class="language-nasm"><span class="token label function">calculateStrLength:</span>
        <span class="token comment" spellcheck="true">;; check is it end of string</span>
        cmp byte <span class="token operator">[</span><span class="token register variable">rsi</span><span class="token operator">]</span>, <span class="token number">0</span>
        <span class="token comment" spellcheck="true">;; if yes exit from function</span>
        je exitFromRoutine
        <span class="token comment" spellcheck="true">;; load byte from rsi to al and inc rsi</span>
        lodsb
        <span class="token comment" spellcheck="true">;; push symbol to stack</span>
        push <span class="token register variable">rax</span>
        <span class="token comment" spellcheck="true">;; increase counter</span>
        inc <span class="token register variable">rcx</span>
        <span class="token comment" spellcheck="true">;; loop again</span>
        jmp calculateStrLength</code></pre>
<p>正如您可以通过它的名称理解他的含义，它只计算输入字符串的长度并将结果存储在rcx寄存器中。首先，我们检查RSI寄存器不指向零，如果是，这是字符串的结尾，我们可以从函数中退出。接下来是lodsb指令。很简单， 他只是把1字节放到al寄存器（16位ax的低位）并更改rsi指针。当我们执行cld指令时，lodsb每次都将rsi从左到右移动到一个字节，因此我们将按字符串元素移动。之后，我们将rax值推送到堆栈，现在它包含字符串中的符号（lodsb将字节从si放到al，al是rax的低8位）。为什么我们要把符号推到堆栈上？你必须记住堆栈是如何工作的，它是按照后进先出的原则工作的。这对我们很有好处。我们将从si中获取第一个元素，将其推到堆栈中，而不是第二个元素，依此类推。所以在堆栈顶部会有字符串的最后一个元素。而不仅仅是从堆栈中逐元素弹出并写入输出缓冲区。在它之后，我们增加计数器（rcx）并再次循环到例程的开始。</p>
<p>As you can understand by it’s name, it just calculates length of INPUT string and store result in rcx register. First of all we check that rsi register doesn’t point to zero, if so this is the end of string and we can exit from function. Next is lodsb instruction. It’s simple, it just put 1 byte to al register (low part of 16 bit ax) and changes rsi pointer. As we executed cld instruction, lodsb everytime will move rsi to one byte from left to right, so we will move by string symbols. After it we push rax value to stack, now it contains symbol from our string (lodsb puts byte from si to al, al is low 8 bit of rax). Why we did push symbol to stack? You must remember how stack works, it works by principle LIFO (last input, first output). It is very good for us. We will take first symbol from si, push it to stack, than second and so on. So there will be last symbol of string at the stack top. Than we just pop symbol by symbol from stack and write to OUTPUT buffer. After it we increment our counter (rcx) and loop again to the start of routine.</p>
<p>好的，我们把所有的符号从字符串推到栈，现在我们可以跳转到exitFromRoutine返回到_start 这里。怎么做？我们有ret指令。代码是这样的：</p>
<p>Ok, we pushed all symbols from string to stack, now we can jump to exitFromRoutine return to _start there. How to do it? We have ret instruction for this. But if code will be like this:</p>
<pre class=" language-nasm"><code class="language-nasm"><span class="token label function">exitFromRoutine:</span>
        <span class="token comment" spellcheck="true">;; return to _start</span>
        ret</code></pre>
<p>它不会起作用的。为什么？这很棘手。记得我们在开始时调用calculateStrLength。当我们调用一个函数时会发生什么？首先，函数的参数从右向左推到堆栈。返回地址将推送到堆栈。所以函数将知道在执行结束后返回哪里。但是看看calculateStrength，我们将符号从字符串推送到堆栈，现在堆栈顶部没有返回地址，函数不知道返回到哪里。如何面对它。现在，我们必须在调用之前查看奇怪的指令：</p>
<p>It will not work. Why? It is tricky. Remember we called calculateStrLength at _start. What occurs when we call a function? First of all function’s parameters pushes to stack from right to left. After it return address pushes to stack. So function will know where to return after end of execution. But look at calculateStrLength, we pushed symbols from our string to stack and now there is no return address of stack top and function doesn’t know where to return. How to be with it. Now we must take a look to the weird instruction before call:</p>
<pre class=" language-nasm"><code class="language-nasm">mov <span class="token register variable">rdi</span>, <span class="token operator">$</span> <span class="token operator">+</span> <span class="token number">15</span></code></pre>
<p>首先：</p>
<ul>
<li>$-返回字符串内存中定义$的位置</li>
<li>$$-返回当前节开始的内存位置</li>
</ul>
<p>所以我们有mov rdi的位置，$+15，但是为什么我们在这里加15？听着，我们需要知道下一行在计算长度后的位置。让我们使用objdump util打开文件：</p>
<p>First all:</p>
<ul>
<li><code>$</code> - returns position in memory of string where $ defined</li>
<li><code>$$</code> - returns position in memory of current section start</li>
</ul>
<p>So we have position of mov rdi, $ + 15, but why we add 15 here? Look, we need to know position of next line after calculateStrLength. Let’s open our file with objdump util:</p>
<pre class=" language-nasm"><code class="language-nasm">objdump <span class="token operator">-</span>D reverse

<span class="token label function">reverse:</span>     file format elf64<span class="token operator">-</span>x86<span class="token number">-64</span>

Disassembly of section .text:

00000000004000b0 <span class="token operator">&lt;</span>_start<span class="token operator">></span>:
  4000b0:    <span class="token number">48</span> be <span class="token number">41</span> <span class="token number">01</span> <span class="token number">60</span> <span class="token number">00</span> <span class="token number">00</span>     movabs <span class="token operator">$</span><span class="token number">0x600141</span>,<span class="token operator">%</span><span class="token register variable">rsi</span>
  4000b7:    <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>
  4000ba:    <span class="token number">48</span> <span class="token number">31</span> c9                 xor    <span class="token operator">%</span><span class="token register variable">rcx</span>,<span class="token operator">%</span><span class="token register variable">rcx</span>
  4000bd:    fc                       cld
  4000be:    <span class="token number">48</span> bf cd <span class="token number">00</span> <span class="token number">40</span> <span class="token number">00</span> <span class="token number">00</span>     movabs <span class="token operator">$</span><span class="token number">0x4000cd</span>,<span class="token operator">%</span><span class="token register variable">rdi</span>
  4000c5:    <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>
  4000c8:    e8 <span class="token number">08</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>           callq  4000d5 <span class="token operator">&lt;</span>calculateStrLength<span class="token operator">></span>
  4000cd:    <span class="token number">48</span> <span class="token number">31</span> c0                 xor    <span class="token operator">%</span><span class="token register variable">rax</span>,<span class="token operator">%</span><span class="token register variable">rax</span>
  4000d0:    <span class="token number">48</span> <span class="token number">31</span> ff                 xor    <span class="token operator">%</span><span class="token register variable">rdi</span>,<span class="token operator">%</span><span class="token register variable">rdi</span>
  4000d3:    eb 0e                    jmp    <span class="token number">4000e3</span> <span class="token operator">&lt;</span>reverseStr<span class="token operator">></span></code></pre>
<p>我们可以看到，第12行（mov rdi，$+15）占用10个字节，第16-5行的函数调用占用15个字节。所以我们的回信地址是mov rdi，$+15。现在，我们可以将返回地址从rdi推送到堆栈并从函数返回：</p>
<p>We can see here that line 12 (our mov rdi, $ + 15) takes 10 bytes and function call at line 16 - 5 bytes, so it takes 15 bytes. That’s why our return address will be mov rdi, $ + 15. Now we can push return address from rdi to stack and return from function:</p>
<pre class=" language-nasm"><code class="language-nasm"><span class="token label function">exitFromRoutine:</span>
        <span class="token comment" spellcheck="true">;; push return addres to stack again</span>
        push <span class="token register variable">rdi</span>
        <span class="token comment" spellcheck="true">;; return to _start</span>
        ret</code></pre>
<p>现在我们回到起点。在调用calculateStrength之后，我们向rax和rdi写入零并跳转到reverseStr标签。具体实施如下：</p>
<p>Now we return to start. After call of the <code>calculateStrLength</code> we write zeros to rax and rdi and jump to reverseStr label. It’s implementation is following:</p>
<pre class=" language-nasm"><code class="language-nasm"><span class="token label function">reverseStr:</span>
        cmp <span class="token register variable">rcx</span>, <span class="token number">0</span>
        je printResult
        pop <span class="token register variable">rax</span>
        mov <span class="token operator">[</span>OUTPUT <span class="token operator">+</span> <span class="token register variable">rdi</span><span class="token operator">]</span>, <span class="token register variable">rax</span>
        dec <span class="token register variable">rcx</span>
        inc <span class="token register variable">rdi</span>
        jmp reverseStr</code></pre>
<p>在这里，我们检查计数器，它是字符串的长度，如果它是零，我们将所有元素写入缓冲区，并可以打印它。检查完计数器后，我们从堆栈弹出到rax寄存器的第一个元素，并将其写入输出缓冲区。我们添加rdi是因为用另一种方法我们将符号写入缓冲区的第一个字节。在此之后，我们通过输出缓冲区增加移动下一个的rdi，减少长度计数器并跳到标签的开始。<br>执行reverseStr之后，我们在输出缓冲区中反转了字符串，可以用新行将结果写入stdout：</p>
<p>Here we check our counter which is length of string and if it is zero we wrote all symbols to buffer and can print it. After checking counter we pop from stack to rax register first symbol and write it to OUTPUT buffer. We add rdi because in other way we’ll write symbol to first byte of buffer. After this we increase rdi for moving next by OUTPUT buffer, decrease length counter and jump to the start of label.</p>
<p>After execution of reverseStr we have reversed string in OUTPUT buffer and can write result to stdout with new line:</p>
<pre class=" language-assembly"><code class="language-assembly">printResult:
        mov rdx, rdi
        mov rax, 1
        mov rdi, 1
        mov rsi, OUTPUT
                syscall
        jmp printNewLine

printNewLine:
        mov rax, SYS_WRITE
        mov rdi, STD_OUT
        mov rsi, NEW_LINE
        mov rdx, 1
        syscall
        jmp exit</code></pre>
<p>从我们的程序退出:</p>
<p>and exit from the our program:</p>
<pre class=" language-assembly"><code class="language-assembly">exit:
        mov rax, SYS_EXIT
        mov rdi, EXIT_CODE
        syscall</code></pre>
<p>就这些,现在我们可以编译我们的程序:</p>
<p>That’s all, now we can compile our program with:</p>
<pre class=" language-makefile"><code class="language-makefile"><span class="token symbol">all</span><span class="token punctuation">:</span>
    nasm -g -f elf64 -o reverse.o reverse.asm
    ld -o reverse reverse.o

<span class="token symbol">clean</span><span class="token punctuation">:</span>
    rm reverse reverse.o</code></pre>
<p>并运行它:</p>
<p>and run it:</p>
<p>![](<a href="https://zhanweisun.github.io/image/Screenshot">https://zhanweisun.github.io/image/Screenshot</a> from 2014-11-20 19_51_15.png?raw=true)</p>
<h4 id="字符串操作"><a href="#字符串操作" class="headerlink" title="字符串操作"></a>字符串操作</h4><p>当然，还有许多其他的字符串/字节操作说明：</p>
<ul>
<li>REP-在rcx不为零时重复</li>
<li>MOVSB-复制字节字符串（MOVSW、MOVSD等）</li>
<li>CMPSB-字节字符串比较</li>
<li>SCASB-字节字符串扫描</li>
<li>STOSB-将字节写入字符串</li>
</ul>
<p>Of course there are many other instructions for string/bytes manipulations:</p>
<ul>
<li><code>REP</code> - repeat while rcx is not zero</li>
<li><code>MOVSB</code> - copy a string of bytes (MOVSW, MOVSD and etc..)</li>
<li><code>CMPSB</code> - byte string comparison</li>
<li><code>SCASB</code> - byte string scanning</li>
<li><code>STOSB</code> - write byte to string</li>
</ul>

            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://zhanweisun.github.io" rel="external nofollow noreferrer">孙老师</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://zhanweisun.github.io/2020/01/11/say-hello-to-x86-64-assembly-part-4/">http://zhanweisun.github.io/2020/01/11/say-hello-to-x86-64-assembly-part-4/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="http://zhanweisun.github.io" target="_blank">孙老师</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/x86/">
                                    <span class="chip bg-color">x86</span>
                                </a>
                            
                                <a href="/tags/x64/">
                                    <span class="chip bg-color">x64</span>
                                </a>
                            
                                <a href="/tags/%E6%B1%87%E7%BC%96/">
                                    <span class="chip bg-color">汇编</span>
                                </a>
                            
                                <a href="/tags/assembly/">
                                    <span class="chip bg-color">assembly</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="qq,qzone,wechat,weibo,douban" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            
        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/01/11/say-hello-to-x86-64-assembly-part-5/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/3.jpg" class="responsive-img" alt="Say hello to x86_64 Assembly [part 5]">
                        
                        <span class="card-title">Say hello to x86_64 Assembly [part 5]</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            翻译原文地址
Say hello to x86_64 Assembly [part 5]这是Say hello to x86_64 Assembly的第五部分，下面我们将介绍宏。它不会是关于x86_64的博客文章，主要是关于nasm汇编程序
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2020-01-11
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            孙老师
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/x86/">
                        <span class="chip bg-color">x86</span>
                    </a>
                    
                    <a href="/tags/x64/">
                        <span class="chip bg-color">x64</span>
                    </a>
                    
                    <a href="/tags/%E6%B1%87%E7%BC%96/">
                        <span class="chip bg-color">汇编</span>
                    </a>
                    
                    <a href="/tags/assembly/">
                        <span class="chip bg-color">assembly</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/01/10/say-hello-to-x86-64-assembly-part-3/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/17.jpg" class="responsive-img" alt="Say hello to x86_64 Assembly [part 3]">
                        
                        <span class="card-title">Say hello to x86_64 Assembly [part 3]</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            翻译原文地址翻译原文地址
Say hello to x86_64 Assembly [part 3]堆栈是存储器中的一个特殊区域，其工作原理是后进先出。
The stack is special region in memory, whic
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-01-10
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            孙老师
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/x86/">
                        <span class="chip bg-color">x86</span>
                    </a>
                    
                    <a href="/tags/x64/">
                        <span class="chip bg-color">x64</span>
                    </a>
                    
                    <a href="/tags/%E6%B1%87%E7%BC%96/">
                        <span class="chip bg-color">汇编</span>
                    </a>
                    
                    <a href="/tags/assembly/">
                        <span class="chip bg-color">assembly</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>

    
<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">年份</span>
            <a href="http://zhanweisun.github.io" target="_blank">孙老师</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    window.setTimeout("siteTime()", 1000);
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2019";
                    var startMonth = "12";
                    var startDate = "4";
                    var startHour = "18";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/zhanweisun" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:847491180@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=847491180" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 847491180" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    

    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    
    
    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
